## ТЗ: расширение (Workbench) для FreeCAD для генерации и теплового расчёта радиаторов под ЧПУ

### 1. Назначение

Создать для FreeCAD (версии 1.0+ ([Wikipedia][1])) Python-расширение (workbench) с GUI для:

1. Параметрической генерации 3D-модели радиатора, пригодной для изготовления на ЧПУ (фрезерная обработка алюминия/меди).
2. Расчёта того, сколько тепла этот радиатор может рассеивать при:

   * температуре окружающего воздуха 25 °C;
   * «обычной» влажности (принять **50 % относительной влажности**, давление 1 атм).
3. Построения графиков зависимости рассеиваемой мощности от:

   * температуры окружающей среды;
   * относительной влажности.

Все расчёты — приближённые инженерные оценки, не точный CFD.

---

### 2. Технологические требования

* Среда: FreeCAD 1.0+, Python 3.x (как встроенный в FreeCAD). ([Wikipedia][1])
* Расширение в виде **отдельного Workbench**: например, `HeatsinkDesigner`.
* Язык реализации: Python.
* GUI: Qt через FreeCAD (PySide2/PySide6, как доступно в текущей сборке).
* Сторонние библиотеки (подключать через обычный `import`, а при отсутствии — показывать пользователю понятное сообщение об ошибке):

  * `ht` — **Heat Transfer** библиотека из ChEDL для расчёта коэффициентов теплоотдачи и тепловых режимов. ([forum.freecad.org][2])
  * `fluids` (из ChEDL) — для свойств воздуха (плотность, вязкость и т.п.). ([PyPI][3])
  * `numpy` — расчёты.
  * `matplotlib` — построение графиков.
* Единицы:

  * В GUI: длины в **мм**, мощности в **Вт**.
  * В расчётах: преобразование в **СИ (метры, Кельвины, Па)**.

---

### 3. Типы радиаторов, поддерживаемые в первой версии

Реализовать минимально 4 типа радиаторов, которые **реально можно фрезеровать на ЧПУ**:

1. **Solid plate** — цельная пластина (без рёбер).
2. **Straight milled fins** — прямые параллельные рёбра:

   * рёбра вдоль длинной стороны;
   * параметризуются: высота, толщина ребра, шаг между рёбрами, толщина основания.
3. **Crosscut (решётка)** — прямые рёбра в двух направлениях (по X и Y), образующие «пины» (квадратные столбики):

   * параметры: высота пинов, шаг сетки, ширина канавки (а значит размер пина).
4. **Pin-fin (штыревой)** — массив квадратных штырей:

   * параметры: сечение пина (квадрат), шаг между пинами, высота пинов, толщина основания.

**Требование по архитектуре:**
Тип радиатора должен задаваться через абстракцию/класс/словарь, чтобы легко добавить новые типы (например, канальные/водоблоки) без переписывания основной логики Workbench’а.

---

### 4. Ограничения и «оптимальные настройки» под ЧПУ (defaults)

Для каждого типа радиатора задать **значения по умолчанию**, исходя из типовых возможностей настольного ЧПУ:

Общие параметры (для всех типов):

* `default_tool_diam_mm = 3.0` — минимальный диаметр фрезы.
* `min_fin_thickness_mm = 2.0` — минимальная толщина ребра ≥ 2/3 диаметра фрезы.
* `min_fin_gap_mm = 3.0` — минимальный зазор между рёбрами для прохода фрезы.
* Радиусы в углах выбирать ≥ `tool_diam/2`.

Примеры дефолтов:

1. **Straight milled fins**

   * Толщина ребра: 2.0 мм.
   * Зазор между рёбрами: 3.0 мм.
   * Толщина основания: 5.0 мм.
   * Высота ребра: 20.0 мм (может быть изменена пользователем).

2. **Crosscut**

   * Ширина канавки (фрезеруемый паз): 3.0 мм.
   * Размер квадратного пина: 3.0 мм.
   * Высота пинов: 15.0 мм.
   * Толщина основания: 5.0 мм.

3. **Pin-fin**

   * Сечение пина: 5×5 мм.
   * Шаг по обеим осям: 8 мм.
   * Высота пинов: 20.0 мм.
   * Толщина основания: 5.0 мм.

4. **Solid plate**

   * Просто пластина толщиной, задаваемой пользователем; дефолт 10 мм.

Все дефолты должны лежать в одном месте (например, словарь `DEFAULT_CNC_PARAMS`), чтобы пользователь мог их править.

---

### 5. Режимы работы (два основных режима)

В GUI сделать переключатель (radio button / combo):

1. **Режим 1: по выбранной геометрии (Surface/Sketch Mode)**
2. **Режим 2: по заданным габаритам (Dimension Mode)**

#### 5.1. Режим 1 — выбор поверхности / эскиза

Поток:

1. Пользователь в FreeCAD выбирает:

   * либо плоскую грань 3D-тела;
   * либо 2D-sketch с замкнутым контуром (прямоугольник/любой контур в плоскости).

2. Нажимает команду **"Heatsink from Face/Sketch"** (кнопка в панели инструмента Workbench’а).

3. Открывается Task Panel с параметрами:

   * **Выбор типа радиатора** (combobox):

     * Solid plate
     * Straight milled fins
     * Crosscut
     * Pin-fin

   * **Параметры радиатора** (зависят от типа; поля подставляют дефолты для ЧПУ):

     * Высота (mm).
     * Толщина ребра/пина (mm).
     * Шаг/количество рёбер или пинов.
     * Толщина основания (mm).
     * Ориентация рёбер (вдоль X или вдоль Y — для прямых рёбер).
     * Флаг «использовать значения по умолчанию для ЧПУ».

   * **Тепловые параметры:**

     * Мощность рассеиваемая компонентами `P_load` (Вт) — опциональное поле.

       * Если не задано → рассчитывается только максимальная рассеиваемая мощность при заданном ΔT (см. раздел 6).
     * Температура окружающей среды `T_amb` (°C), дефолт 25.
     * Влажность `RH` (%), дефолт 50.

   * **Кнопки:**

     * `Сгенерировать 3D-модель` — создаёт твёрдотельный объект радиатора, привязанный к выбранной поверхности/эскизу.
     * `Рассчитать тепло` — выполняет тепловой расчёт (см. раздел 6) и выводит:

       * максимальную рассеиваемую мощность при заданном ΔT;
       * если `P_load` задано — оценку температуры радиатора.
     * `График (T, RH)` — строит график зависимости рассеиваемой мощности от T и RH (см. раздел 7).

4. Геометрия:

   * Основание радиатора совпадает с выбранной поверхностью/контуром.
   * Радиатор вырастает **наружу** от поверхности (в направлении нормали), не вглубь детали.

#### 5.2. Режим 2 — по заданным габаритам (оптимальный радиатор)

Второй инструмент: **"Heatsink by Dimensions"**.

Поток:

1. Пользователь не обязан ничего выделять.
2. В Task Panel вводит:

   * Ширину радиатора `W` (mm).
   * Длину радиатора `L` (mm).
   * Допустимую высоту `H_max` (mm).
   * (Опционально) рассеиваемую мощность `P_load` (Вт).
3. Режимы выбора типа:

   * Переключатель:

     * `Тип: Авто (подбор оптимального)`
     * `Тип: Ручной (выбор из списка)` — тогда становится доступен combobox с типами как в режиме 1.
4. При `Тип: Авто`:

   * Код **перебирает все доступные типы радиаторов**, и для каждого — набор разумных конфигураций в пределах:

     * высота ≤ `H_max`;
     * зазоры/толщина не нарушают `DEFAULT_CNC_PARAMS`.
   * Для каждого кандидата рассчитывает:

     * суммарную эффективную площадь теплообмена;
     * коэффициент теплоотдачи для естественной конвекции;
     * **максимальную рассеиваемую мощность при заданном ΔT** (см. раздел 6).
   * Выбирает конфигурацию с **минимальным тепловым сопротивлением** (или максимальной рассеиваемой мощностью).
5. Кнопки:

   * `Подобрать и сгенерировать` — создаёт 3D-модель выбранного «оптимального» радиатора.
   * `Рассчитать тепло` — выводит численные результаты.
   * `График (T, RH)` — строит график.

---

### 6. Тепловой расчёт

Цель — дать оценку:

1. **Максимальная рассеиваемая мощность** при заданных условиях (T_amb, RH, ΔT).
2. **Температура радиатора** при заданной нагрузке `P_load`.

#### 6.1. Физические допущения

* Радиатор в **естественной конвекции** в неподвижном воздухе.
* Радиатор ориентирован вертикально (для рёбер — рёбра вертикальные).
* Давление воздуха: 1 атм.
* Свойства воздуха (плотность, вязкость, теплоёмкость, теплопроводность) получаются из библиотек `fluids` / `ht` как функции температуры и, по возможности, влажности. ([forum.freecad.org][2])
* Влияние влажности на свойства воздуха можно учитывать упрощённо:

  * либо через функцию `fluids` / свои расчёты влажного воздуха;
  * либо через небольшой поправочный коэффициент по RH (приближённо).
* Излучение можно:

  * либо игнорировать (упростить);
  * либо ввести как дополнительный член теплообмена с усреднённым коэффициентом (но это opcion).

#### 6.2. Математическая модель (общая)

* Сначала вычислить **эффективную площадь теплообмена A_eff** для текущей геометрии:

  * сумма площадей боковых поверхностей рёбер/пинов;
  * плюс верхняя площадь рёбер/пинов;
  * плюс часть площади основания, контактирующая с воздухом.
* Вычислить коэффициент конвективной теплоотдачи `h`:

  * использовать функции библиотеки `ht` для естественной конвекции от пластин/поверхностей (корреляции по Nusselt/Grashof/Rayleigh). ([HT Documentation][4])
  * При необходимости вводится поправка для плотной группы рёбер (замкнутые каналы).
* Для **простого варианта** можно считать, что вся поверхность радиатора имеет один и тот же `h`:

  * `Q = h * A_eff * (T_surface - T_amb)`.
* Если задана максимально допустимая температура поверхности `T_surface_max` (например, `T_amb + 40 °C` по умолчанию):

  * `Q_max = h * A_eff * ΔT_max`.
* Если задана `P_load`:

  * найти `T_surface = T_amb + P_load / (h * A_eff)`.

Дополнительно (опционально, но хорошо):

* Для рёбер использовать классическую теорию одноразмерных пластинчатых ребер:

  * учитывать эффективность ребер (коэффициент <1) и уменьшать эффективную площадь.

#### 6.3. Зависимость от T и RH для графика

Для кнопки «График»:

* Построить массив значений:

  * `T_amb` от 0 до 80 °C (шаг 5 °C).
  * несколько фиксированных значений `RH`: например, 30 %, 60 %, 90 %.
* Для каждой пары (T_amb, RH) вычислить:

  * `Q_max(T_amb, RH)` при фиксированном допустимом перегреве ΔT (например 40 °C).
* Построить график:

  * Ось X: `T_amb`.
  * Ось Y: `Q_max` (Вт).
  * По одной линии на каждое значение RH (легенда).

---

### 7. Графический интерфейс (GUI)

Требования:

1. **Новый Workbench** (`HeatsinkDesignerWB`) с:

   * Иконкой;
   * Toolbar с минимум двумя кнопками:

     * `Heatsink from Face/Sketch`;
     * `Heatsink by Dimensions`.
2. Каждая команда открывает **Task Panel** (Qt-форма), которая:

   * Показывает все параметры для выбранного режима.
   * Имеет кнопки:

     * `Сгенерировать 3D-модель` / `Подобрать и сгенерировать` (в зависимости от режима);
     * `Рассчитать тепло`;
     * `График (T, RH)`;
     * `Закрыть`.
3. Диалог ошибок:

   * Если не выбрана плоская поверхность/скетч — показать понятное сообщение.
   * Если библиотека `ht` / `fluids` не установлена:

     * показать диалог:
       «Не установлена библиотека ht/fluids. Установите через pip: `pip install ht fluids` и перезапустите FreeCAD.»
4. График:

   * Использовать `matplotlib` внутри Qt (FigureCanvas) либо открыть отдельное окно.
   * Возможность сохранить график как PNG (кнопка `Сохранить график` на панели или стандартное меню matplotlib).

---

### 8. Геометрическое моделирование в FreeCAD

* В режиме 1:

  * Из выбранной грани/скетча получить:

    * плоскость;
    * контур (инициализировать основание радиатора).
  * Построить твёрдое тело:

    * Основание: extrude в направлении нормали на толщину основания.
    * Рёбра/пины: дополнительные экструдированные тела, объединённые булевой операцией (fusion) с основанием.
* В режиме 2:

  * Создать прямоугольник `L × W` на выбранной базовой плоскости (например, XY).
  * Аналогично построить основание и рёбра/пины.
* Все параметры (высота, шаг и т.д.) должны быть **параметрическими** (использовать свойства FreeCAD объектов), чтобы пользователь мог изменить их позже и перестроить модель.

---

### 9. Структура кода расширения

Рекомендуемая структура (не жёстко, но полезно):

* Папка Workbench’а, например `HeatsinkDesigner`:

  * `Init.py` — регистрация модуля.
  * `InitGui.py` — регистрация Workbench, иконки, команд. ([forum.freecad.org][5])
  * `heatsink_types.py` — описание типов радиаторов и их геометрических параметров/дефолтов.
  * `cnc_defaults.py` — константы с рекомендуемыми параметрами под ЧПУ.
  * `thermal_model.py` — тепловые расчёты (вся работа с `ht`, `fluids`, `numpy`).
  * `geometry_builder.py` — функции построения 3D-геометрии в FreeCAD для каждого типа радиатора.
  * `gui_face_mode.py` — Task Panel и логика режима 1.
  * `gui_dim_mode.py` — Task Panel и логика режима 2.
  * `icons/` — иконки команд/Workbench’а.

---

### 10. Нефункциональные требования

* Код должен быть:

  * Разбит на модули (GUI / геометрия / расчёт).
  * Комментирован (минимум docstring’и на ключевые функции).
* Обработка ошибок:

  * Не падать при отсутствующих зависимостях, а показывать понятное сообщение.
  * Проверять ввод: отрицательные длины, нулевые размеры, высота > 0, шаг > толщина и т.п.
* Тесты (минимум):

  * Модульные тесты для `thermal_model.py` на нескольких простых конфигурациях (например, сравнение с ручным расчётом `Q = h*A*ΔT` для голой пластины).
* Производительность:

  * Подбор «оптимального радиатора» в режиме 2 должен использовать ограниченный перебор параметров (ограничение по количеству комбинаций) чтобы не зависать.
